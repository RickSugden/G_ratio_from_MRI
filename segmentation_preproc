#!/bin/bash
clear
#Instructions:
#This script is simply to resize a nifty file so that its dimensions match those of freesurfer segmentation. 
# this will allow mri_segstats to calculate the average intensity (along with other stats) of whatever map (say FA) 
# is used as input. This does not perform any distortion correction. Create a directory for segmentation processing. 
# inside that directory, place the file you want to upscale in a folder called "to_be_seg". This script will create a temp
# folder in the segmentation directory and put the output in a sub-directory "summaries". 

#ACTIONS NEEDED TO INITIALIZE
# 1. setup an environment variable PROJ_HOME to wherever you will place the segmentation folder
# 2. make the directory $PROJ_HOME/segmentation_processing
# 3. make the sub-directories:
# $PROJ_HOME/segmentation_processing/to_be_seg [whatever you want to apply the segmentation to]
# $PROJ_HOME/segmentation_processing/temp (optional, will be generated by script)
# $PROJ_HOME/segmentation_processing/summaries (optional, will be generated by script)
# 4. in to_be_seg, place a FOLDER for each patient, named by their patient id (P3T1). Inside each folder, place the 
# respective FA map, or whatever measurement of interest
# 5. users of freesurfer are required to have a directory $SUBJECTS_DIR where segmentations will be saved. If you 
# are not a freesurfer user but want to use this script, you will need to make the directory:
# $SUBJECTS_DIR/$subj_id/mri/segmentationName.mgz
# example: $SUBJECTS_DIR/P3T1/mri/wmparc.mgz
# note: the subj_id variable is controlled by the for loop below. 
# 6. look for the several "ACTION REQUIRED" below


echo " "
echo "Freesurfer segmentation stats calculator"
echo "By: Rick Sugden, rsugden@uwo.ca"
echo " "
##########################################################
# Freesurfer segmentation preprocessing pipeline
##########################################################
# ACTION REQUIRED manually input FA or measuremet of iterest file name. This file must be in the folder to_be_seg.
#this also assumes that if you're processing multiple subjects, although their maps are in their respective folders, they
# need to have the same name (so make it generic).

#name the subj_id such that $SUBJECTS_DIR/$subj_id/mri/wmparc.mgz or aseg.mgz is your segmentation from freesurfer. if you 
#did not change the patient's folder name, it will still be whatever subject id you fed into freesurfer.

# ACTION REQUIERDdti_FA_upsampled this list should contain whatever patients you wish to conduct this on which are in the folder to_be_seg
for subj_id in  P2 P3 P4 P5 P6 P7 P8 P9 P10 P11 P12 P13 ; do #
    filename=MWF_Map_WB.nii.gz

    #go to the input folder and save its path accordingly
    cd $PROJ_HOME/segmentation_processing/MWF/$subj_id
    IN_DIR=`pwd`

    #go one level above the seg_proc_temp (the temp output folder)
    cd $PROJ_HOME/segmentation_processing

    #remove the folder that contained the output from last time and make a new one
    rm -rf temp
    mkdir $PROJ_HOME/segmentation_processing/temp 

    cd $PROJ_HOME/segmentation_processing/temp 
    TEMP_DIR=`pwd`

    #enter the output folder and save its path accordingly
    cd $PROJ_HOME/segmentation_processing/summaries
    OUT_DIR=`pwd`

    #Upsample the dwi data (or other data of interest).
    cd $IN_DIR
    echo "Upsampling the data..." 
    #this will upsample the to_be_seg file and save it in the new temp folder as seg_upsampled_"subj_id"
    #the resolution it samples to match is the -template option. In this case we want our FA or data of interest
    #to match the segmentation file wmparc/"aseg.mgz" which is generated by freesurfer and stored under SUBJECTS_DIR/.../mri
    #ACTION REQUIRED make a choice for which segmentation to use.
    mrgrid $IN_DIR/$filename regrid $TEMP_DIR/mwf_upsampled_$subj_id.nii.gz -voxel 1 -interp linear -template $SUBJECTS_DIR/$subj_id"T1"/mri/wmparc.mgz 

    #take this out if not required. the TTP data collected by Jeff Hamilton had the axis swapped around
    fslswapdim $TEMP_DIR/mwf_upsampled_$subj_id -z -y -x $TEMP_DIR/mwf_upsampled_"$subj_id"_swapped

    echo "Preprocessing of data is finished! mri_segstats may now be used..." 
    echo ""

    #now that we have taken the input file, upsampled it and placed it in the temp folder, we shall move to the temp folder to continue
    cd $TEMP_DIR
    echo "Processing the mean intensity of input according to the reference segmentation..." 
    #create file before writing in it
    sudo touch $OUTDIR/$subj_id"_MWF_freehand_sum"

    #ACTION REQUIRED make a choice for which segmentation to use.
    #this will measure the intensity of --i according to the segments provided by --seg, it will output a summary under --sum
    mri_segstats --i $TEMP_DIR/mwf_upsampled_"$subj_id"_swapped.nii.gz --sum $OUT_DIR/$subj_id"_MWF_freehand_sum" --seg $SUBJECTS_DIR/$subj_id"T1"/mri/freehand_collosum.mgz

    echo "All done! Check the output folder to ensure results were achieved"
done; 